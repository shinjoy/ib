<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Board">
	<typeAlias alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias alias="boardVO" type="ib.board.service.impl.BoardVO"/>
	<typeAlias alias="spCmmVO" type="ib.schedule.service.SpCmmVO"/>
	
	<!-- 선택 게시판 그룹 정보 -->
	<resultMap id="GrpInfo" class="ib.board.service.impl.BoardVO">
		<result property="GrpCd"				column="GrpCd"/>
		<result property="GrpNm"				column="GrpNm"/>
		<result property="GrpInfo"				column="GrpInfo"/>
		<result property="ConfirmProcFlag"		column="ConfirmProcFlag"/>
		<result property="CateCd"				column="CateCd"/>
		<result property="CateNm"				column="CateNm"/>
		<result property="CateInfo"				column="CateInfo"/>
	</resultMap>
	
	<!-- 게시물 정보 -->
	<resultMap id="BoardInfo" class="ib.board.service.impl.BoardVO">
		<result property="GrpCd"				column="GrpCd"/>
		<result property="GrpNm"				column="GrpNm"/>
		<result property="ConfirmProcFlag"		column="ConfirmProcFlag"/>
		<result property="CateCd"				column="CateCd"/>
		<result property="CateNm"				column="CateNm"/>
		<result property="WriteCd"				column="WriteCd"/>
		<result property="WriteTitle"			column="WriteTitle"/>
		<result property="WriteCon"				column="WriteCon"/>
		<result property="NoticeFlag"			column="NoticeFlag"/>
		<result property="NoticeSDate"			column="NoticeSDate"/>
		<result property="NoticeEDate"			column="NoticeEDate"/>
		<result property="ConfirmPerSabun"		column="ConfirmPerSabun"/>
		<result property="ConfirmPerNm"			column="ConfirmPerNm"/>
		<result property="Hit"					column="Hit"/>
		<result property="WriteStatus"			column="WriteStatus"/>
		<result property="BoardVer"				column="BoardVer"/>
		<result property="HoliDocFlag"			column="HoliDocFlag"/>
		<result property="HoliFlag"				column="HoliFlag"/>
		<result property="HalfFlag"				column="HalfFlag"/>
		<result property="HoliSDate"			column="HoliSDate"/>
		<result property="HoliSDateNm"			column="HoliSDateNm"/>
		<result property="HoliEDate"			column="HoliEDate"/>
		<result property="HoliEDateNm"			column="HoliEDateNm"/>
		<result property="HoliUseDay"			column="HoliUseDay"/>
		<result property="HoliCancelCd"			column="HoliCancelCd"/>
		<result property="HoliFlagNm"			column="HoliFlagNm"/>
		<result property="HalfFlagNm"			column="HalfFlagNm"/>
		<result property="EventSelCd1"			column="EventSelCd1"/>
		<result property="EventSelCd2"			column="EventSelCd2"/>
		<result property="EventDay"				column="EventDay"/>
		<result property="EventDoc"				column="EventDoc"/>
		<result property="RegDate"				column="RegDate"/>
		<result property="RegPerSabun"			column="RegPerSabun"/>
		<result property="RegPerNm"				column="RegPerNm"/>
		<result property="MiddleCnt"			column="MiddleCnt"/>
		<result property="EndCnt"				column="EndCnt"/>
		<result property="ReturnCnt"			column="ReturnCnt"/>
		<result property="PerPositionNm"		column="PerPositionNm"/>
		<result property="PerDept"				column="PerDept"/>
		<result property="PerJoinCom"			column="PerJoinCom"/>
		<result property="DelFlag"				column="DelFlag"/>
	</resultMap>
	
	<!-- 파일 정보 -->
	<resultMap id="BoardFileInfo" class="ib.board.service.impl.BoardVO">
		<result property="GrpCd"				column="GrpCd"/>
		<result property="CateCd"				column="CateCd"/>
		<result property="WriteCd"				column="WriteCd"/>
		<result property="FileSeq"				column="FileSeq"/>
		<result property="FileNm"				column="FileNm"/>
		<result property="FileUpNm"				column="FileUpNm"/>
		<result property="FilePath"				column="FilePath"/>
		<result property="FileSize"				column="FileSize"/>
		<result property="FileOrder"			column="FileOrder"/>
	</resultMap>
	
																		<!-- 관리자 -->
	<!-- 게시판 그룹&카테고리 리스트 받아오기 -->
	<select id="boardDAO.GetGrpCateList" resultClass="egovMap">
		SELECT PCFlag, GrpCd, Cnt, CateCd, GrpNm, GrpInfo, GrpOrder, CateOrder,
			ConfirmProcFlag, CASE WHEN ConfirmPerSabun != '' THEN '사용' ELSE '사용안함' END ConfirmProcNm, 
			ConfirmPerSabun, (SELECT PerNm FROM erp.ERP_Per WHERE PerSabun = ConfirmPerSabun) ConfirmPerNm,
			HoliDocFlag, CASE HoliDocFlag WHEN 'Y' THEN '사용' ELSE '사용안함' END HoliDocFlagNm, DelFlag FROM (
				SELECT 'P' PCFlag, GrpCd, (SELECT COUNT(*) FROM ib_boardCate WHERE GrpCd = grp.GrpCd AND DelFlag = 'N') Cnt, '' CateCd,
				    GrpNm, GrpInfo, GrpOrder, 0 CateOrder, ConfirmProcFlag, '' ConfirmPerSabun, '' HoliDocFlag, DelFlag FROM ib_boardGrp grp WHERE DelFlag = 'N'
				UNION ALL
				SELECT 'C' PCFlag, GrpCd, 0, CateCd,
				    CateNm, CateInfo, (SELECT GrpOrder FROM ib_boardGrp WHERE GrpCd = cate.GrpCd), CateOrder,
				    (SELECT ConfirmProcFlag FROM ib_boardGrp WHERE GrpCd = cate.GrpCd), ConfirmPerSabun, HoliDocFlag, DelFlag
				FROM ib_boardCate cate WHERE DelFlag = 'N'
			) a
		ORDER BY GrpOrder, CateOrder
	</select>

<!-- 그룹관련 -->
	<!-- 게시판 그룹 등록을 위한 그룹코드 받아오기 -->
	<select id="boardDAO.GetGrpCd" resultClass="String">
		<!-- SELECT IFNULL(LPAD(MAX(GrpCd) + 1, 12, 0), '000000000001') GrpCd FROM ib_boardGrp -->
		SELECT IFNULL(MAX(GrpCd) + 1, '1') GrpCd FROM ib_boardGrp
	</select>
	
	<!-- 게시판 그룹 등록/수정/삭제 완료 -->
	<insert id="boardDAO.GrpProcEnd">
		INSERT INTO ib_boardGrp (GrpCd, GrpNm, GrpInfo, GrpOrder, ConfirmProcFlag,
			RegPerSabun, RegDate, EditPerSabun, EditDate, DelPerSabun, DelDate, DelFlag) VALUES
		(#GrpCd#, #GrpNm#, #GrpInfo#, #GrpOrder#, #ConfirmProcFlag#,
			#RegPerSabun#, NOW(), NULL, NULL, NULL, NULL, 'N')
		<isNotEqual property="CMD" compareValue="Add">ON DUPLICATE KEY UPDATE</isNotEqual>
		<isEqual property="CMD" compareValue="Edit">
			GrpNm = VALUES(GrpNm), GrpInfo = VALUES(GrpInfo), GrpOrder = VALUES(GrpOrder), ConfirmProcFlag = VALUES(ConfirmProcFlag),
			EditPerSabun = VALUES(RegPerSabun), EditDate = NOW()
		</isEqual>
		<isEqual property="CMD" compareValue="Del">GrpOrder = NULL, DelPerSabun = VALUES(RegPerSabun), DelDate = NOW(), DelFlag = 'Y'</isEqual>
	</insert>
	
	<!-- 게시판 그룹 등록/수정에 따른 순서 업데이트 (기존값 > 변경값) -->
	<update id="boardDAO.GrpOrderUpEditEnd">
		UPDATE ib_boardGrp SET GrpOrder = (GrpOrder + 1)
		WHERE GrpCd IN (SELECT GrpCd FROM (SELECT GrpCd FROM ib_boardGrp WHERE GrpCd != #GrpCd# AND GrpOrder BETWEEN #GrpOrder# AND #GrpOrderLog# AND DelFlag = 'N') a)
	</update>
	
	<!-- 게시판 그룹 등록/수정에 따른 순서 업데이트 (기존값 < 변경값) -->
	<update id="boardDAO.GrpOrderDownEditEnd">
		UPDATE ib_boardGrp SET GrpOrder = (GrpOrder - 1)
		WHERE GrpCd IN (SELECT GrpCd FROM (SELECT GrpCd FROM ib_boardGrp WHERE GrpCd != #GrpCd# AND GrpOrder BETWEEN #GrpOrderLog# AND #GrpOrder# AND DelFlag = 'N') a)
	</update>
	
	<!-- 게시판 그룹 삭제에 따른 순서 업데이트 -->
	<update id="boardDAO.GrpOrderEditEnd">
		UPDATE ib_boardGrp SET GrpOrder = (GrpOrder - 1) WHERE GrpOrder > (SELECT GrpOrder FROM (SELECT GrpOrder FROM ib_boardGrp WHERE GrpCd = #GrpCd#) a)
	</update>
	
	<!-- 게시판 그룹 삭제에 따른 카테고리 삭제 -->
	<update id="boardDAO.GrpCateDelEnd">
		UPDATE ib_boardCate SET DelPerSabun = #GrpCd#, DelDate = NOW(), DelFlag = 'Y'
		WHERE GrpCd = #GrpCd# AND CateCd IN (SELECT CateCd FROM (SELECT CateCd FROM ib_boardCate WHERE GrpCd = #GrpCd#) a)
	</update>
<!-- 그룹관련 -->
	
<!-- 카테고리관련 -->
	<!-- 게시판 공개자&수신자 리스트 받아오기 -->
	<select id="boardDAO.GetCateOptPerList" resultClass="egovMap">
		SELECT (SELECT GrpOrder FROM ib_boardGrp WHERE GrpCd = opt.GrpCd) GrpOrder,
		    (SELECT CateOrder FROM ib_boardCate WHERE GrpCd = opt.GrpCd AND CateCd = opt.CateCd) CateOrder,
		    GrpCd, CateCd, PerSabun, (SELECT PerNm FROM erp.ERP_Per WHERE PerSabun = opt.PerSabun) PerNm, OptFlag, DelFlag
		FROM ib_boardCateOpt opt
		ORDER BY GrpOrder, CateOrder, OptFlag, PerNm
	</select>
	
	<!-- 게시판 카테고리 등록을 위한 카테고리코드 받아오기 -->
	<select id="boardDAO.GetCateCd" parameterClass="boardVO" resultClass="String">
		<!-- SELECT IFNULL(LPAD(MAX(CateCd) + 1, 12, 0), '000000000001') CateCd FROM ib_boardCate WHERE GrpCd = #GrpCd# -->
		SELECT IFNULL(MAX(CateCd) + 1, '1') CateCd FROM ib_boardCate WHERE GrpCd = #GrpCd#
	</select>
	
	<!-- 게시판 카테고리 등록/수정/삭제 완료 -->
	<insert id="boardDAO.CateProcEnd">
		INSERT INTO ib_boardCate (GrpCd, CateCd, CateNm, CateInfo, CateOrder, ConfirmPerSabun, HoliDocFlag,
			RegPerSabun, RegDate, EditPerSabun, EditDate, DelPerSabun, DelDate, DelFlag) VALUES
		(#GrpCd#, #CateCd#, #CateNm#, #CateInfo#, #CateOrder#, #ConfirmPerSabun#, #HoliDocFlag#,
			#RegPerSabun#, NOW(), NULL, NULL, NULL, NULL, 'N')
		<isNotEqual property="CMD" compareValue="Add">ON DUPLICATE KEY UPDATE</isNotEqual>
		<isEqual property="CMD" compareValue="Edit">
			CateNm = VALUES(CateNm), CateInfo = VALUES(CateInfo), CateOrder = VALUES(CateOrder), ConfirmPerSabun = VALUES(ConfirmPerSabun), HoliDocFlag = VALUES(HoliDocFlag),
			EditPerSabun = VALUES(RegPerSabun), EditDate = NOW()
		</isEqual>
		<isEqual property="CMD" compareValue="Del">CateOrder = NULL, DelPerSabun = VALUES(RegPerSabun), DelDate = NOW(), DelFlag = 'Y'</isEqual>
	</insert>
	
	<!-- 게시판 공개자&수신자 등록/수정 완료 -->
	<insert id="boardDAO.CateOptProcEnd" parameterClass="java.util.List">
		INSERT INTO ib_boardCateOpt (GrpCd, CateCd, PerSabun, OptFlag, RegPerSabun, RegDate, EditPerSabun, EditDate, DelFlag) VALUES
        <dynamic>
		<iterate conjunction=",">
			(#[].GrpCd#, #[].CateCd#, #[].PerSabun#, #[].OptFlag#, #[].RegPerSabun#, NOW(), NULL, NULL, #[].DelFlag#)
		</iterate>
		</dynamic>
		ON DUPLICATE KEY UPDATE EditPerSabun = VALUES(RegPerSabun), EditDate = NOW(), DelFlag = VALUES(DelFlag)
	</insert>
	
	<!-- 게시판 등록/수정에 따른 순서 업데이트 (기존값 > 변경값) -->
	<update id="boardDAO.CateOrderUpEditEnd">
		UPDATE ib_boardCate SET CateOrder = (CateOrder + 1)
		WHERE GrpCd = #GrpCd#
		AND CateCd IN (SELECT CateCd FROM (SELECT CateCd FROM ib_boardCate WHERE GrpCd = #GrpCd# AND CateCd != #CateCd# AND CateOrder BETWEEN #CateOrder# AND #CateOrderLog# AND DelFlag = 'N') a)
	</update>
	
	<!-- 게시판 등록/수정에 따른 순서 업데이트 (기존값 < 변경값) -->
	<update id="boardDAO.CateOrderDownEditEnd">
		UPDATE ib_boardCate SET CateOrder = (CateOrder - 1)
		WHERE GrpCd = #GrpCd#
		AND CateCd IN (SELECT CateCd FROM (SELECT CateCd FROM ib_boardCate WHERE GrpCd = #GrpCd# AND CateCd != #CateCd# AND CateOrder BETWEEN #CateOrderLog# AND #CateOrder# AND DelFlag = 'N') a)
	</update>
	
	<!-- 게시판 삭제에 따른 순서 업데이트 -->
	<update id="boardDAO.CateOrderEditEnd">
		UPDATE ib_boardCate SET CateOrder = (CateOrder - 1) WHERE GrpCd = #GrpCd#
		AND CateOrder > (SELECT CateOrder FROM (SELECT CateOrder FROM ib_boardCate WHERE GrpCd = #GrpCd# AND CateCd = #CateCd#) a)
	</update>
<!-- 카테고리관련 -->
																		<!-- 관리자 -->
																		
																		<!-- 타이틀 -->
	<!-- 게시판 그룹 리스트 불러오기(메뉴) -->
	<select id="boardDAO.GetBoardGrpList" resultClass="egovMap">
		SELECT GrpCd, GrpNm, GrpInfo, GrpOrder, ConfirmProcFlag FROM ib_boardGrp a 
		WHERE DelFlag = 'N' AND (SELECT COUNT(*) FROM ib_boardCate WHERE GrpCd = a.GrpCd AND DelFlag = 'N') > 0
		ORDER BY GrpOrder
	</select>
	
	<!-- 게시판 리스트 불러오기(카테고리) -->
	<select id="boardDAO.GetBoardCateList" parameterClass="boardVO" resultClass="egovMap">
		SELECT a.GrpCd, GrpNm, GrpInfo, ConfirmProcFlag, HoliDocFlag,
		    a.CateCd, CateNm, CateInfo, CateOrder, ConfirmPerSabun, ConfirmPerNm,
		    ViewBoardCnt, BoardCnt, IFNULL(ReadCnt, 0) ReadCnt, newCnt, noReadCnt
		FROM
		    (SELECT grp.GrpCd, GrpNm, GrpInfo, ConfirmProcFlag, HoliDocFlag,
				CateCd, CateNm, CateInfo, CateOrder, ConfirmPerSabun, (SELECT PerNm FROM erp.ERP_Per WHERE PerSabun = ConfirmPerSabun) ConfirmPerNm,
		        <isEqual property="GrpCd" compareValue="1">
		        	(SELECT COUNT(1) FROM ib_board a
						WHERE a.GrpCd = cate.Grpcd AND a.CateCd = cate.CateCd AND a.DelFlag = 'N') ViewBoardCnt,		<!-- 전체 게시글 수-->
					(SELECT COUNT(1) FROM ib_board a, ib_boardConfirmOpt b
						WHERE a.GrpCd = cate.Grpcd AND a.CateCd = cate.CateCd AND a.DelFlag = 'N' AND IFNULL(a.EditDate, a.RegDate) 
							AND a.GrpCd = b.GrpCd AND a.CateCd = b.CateCd AND a.WriteCd = b.WriteCd
							AND b.PerSabun = #RegPerSabun# AND b.OptFlag = 'consult' AND b.DelFlag = 'N'
							AND NOT EXISTS 
								(SELECT 1 FROM ib_boardReadLog c 
								WHERE c.GrpCd = a.GrpCd AND a.CateCd = c.CateCd AND a.WriteCd = c.WriteCd AND b.PerSabun = #RegPerSabun#
							)
					) BoardCnt,			<!-- 내가 참조 인 수-->
							
					(SELECT COUNT(1) FROM ib_board a, ib_boardConfirmOpt b
						WHERE a.GrpCd = cate.Grpcd AND a.CateCd = cate.CateCd AND a.DelFlag = 'N' AND IFNULL(a.EditDate, a.RegDate) BETWEEN DATE_ADD(NOW(), INTERVAL -7 DAY)  AND NOW()
							AND a.GrpCd = b.GrpCd AND a.CateCd = b.CateCd AND a.WriteCd = b.WriteCd
							AND b.PerSabun = #RegPerSabun# AND b.OptFlag = 'consult' AND b.DelFlag = 'N') newCnt,			<!-- 한달 사이 신규 글 수 -->	
					
					
					(SELECT COUNT(1) FROM ib_board a
	                	 WHERE
	                    	a.GrpCd = cate.Grpcd AND a.CateCd = cate.CateCd  AND a.DelFlag = 'N' AND  WriteStatus != 'write'
	                    	AND IFNULL(a.EditDate, a.RegDate) > IFNULL((SELECT  PERJOINCOM  FROM erp.ERP_PER WHERE PERSABUN = #RegPerSabun#), DATE_FORMAT(NOW(), '%Y-%m-%d'))
                       		AND NOT EXISTS 
								(SELECT 1 FROM ib_boardReadLog c WHERE c.GrpCd = a.GrpCd AND a.CateCd = c.CateCd AND a.WriteCd = c.WriteCd AND c.PerSabun = #RegPerSabun#)
                     ) noReadCnt	<!-- 입사 이후 안읽은 게시글 수 -->
					
				</isEqual>
		        <isNotEqual property="GrpCd" compareValue="1">
		        	(SELECT COUNT(1) FROM ib_board a
						WHERE a.GrpCd = cate.Grpcd AND a.CateCd = cate.CateCd AND a.DelFlag = 'N') ViewBoardCnt,		<!-- 전체 게시글 수 -->
						
					(SELECT COUNT(1) FROM ib_board a
						WHERE a.GrpCd = cate.Grpcd AND a.CateCd = cate.CateCd AND a.DelFlag = 'N' AND IFNULL(a.EditDate, a.RegDate) > '2014-05-01') BoardCnt,	<!-- 2014-05-01  이후 전체 게시글 수 -->
					
					(SELECT COUNT(1) FROM ib_board a
						WHERE a.GrpCd = cate.Grpcd AND a.CateCd = cate.CateCd AND a.DelFlag = 'N' AND IFNULL(a.EditDate, a.RegDate) BETWEEN DATE_ADD(NOW(), INTERVAL -7 DAY)  AND NOW() ) newCnt, <!-- 한달 사이 신규 글 수 -->		
		       
		       		(SELECT COUNT(1) FROM ib_board a
	                	 WHERE
	                    	a.GrpCd = cate.Grpcd
	                        AND a.CateCd = cate.CateCd
	                        AND a.DelFlag = 'N'
	                        AND IFNULL(a.EditDate, a.RegDate) > IFNULL((SELECT  PERJOINCOM  FROM erp.ERP_PER WHERE PERSABUN = #RegPerSabun#), DATE_FORMAT(NOW(), '%Y-%m-%d'))
                       		AND NOT EXISTS 
								(SELECT 1 FROM ib_boardReadLog c WHERE c.GrpCd = a.GrpCd AND a.CateCd = c.CateCd AND a.WriteCd = c.WriteCd AND c.PerSabun = #RegPerSabun#)
                     ) noReadCnt	<!-- 입사 이후 안읽은 게시글 수 -->
		       
		       
		        </isNotEqual>
		    FROM ib_boardGrp grp, ib_boardCate cate
		    WHERE grp.GrpCd = #GrpCd# AND grp.GrpCd = cate.GrpCd AND cate.DelFlag = 'N') a
		        LEFT OUTER JOIN
		    (SELECT a.GrpCd, a.CateCd, COUNT(1) ReadCnt
		    	FROM
		        <!-- <isEqual property="GrpCd" compareValue="1">
			        (SELECT a.GrpCd, a.CateCd, a.WriteCd, a.RegDate, a.EditDate FROM ib_board a
						WHERE a.GrpCd = #GrpCd# AND a.DelFlag = 'N' ) a, ib_boardReadLog b
				</isEqual>
				<isNotEqual property="GrpCd" compareValue="1"> -->
					(SELECT a.GrpCd, a.CateCd, a.WriteCd, a.RegDate, a.EditDate FROM ib_board a
						WHERE a.GrpCd = #GrpCd# AND a.DelFlag = 'N' ) a, ib_boardReadLog b
				<!-- </isNotEqual> -->
			    WHERE a.GrpCd = b.GrpCd AND a.CateCd = b.CateCd AND a.WriteCd = b.WriteCd AND b.PerSabun = #RegPerSabun# AND ReadDate > IFNULL(EditDate, RegDate)
			    GROUP BY a.GrpCd , a.CateCd
			) c ON a.GrpCd = c.GrpCd	AND a.CateCd = c.CateCd
		
		ORDER BY CateOrder
	</select>
	
	<!-- 선택된 게시판 그룹 및 게시판 정보 받아오기 -->
	<select id="boardDAO.GetGrpInfo" resultMap="GrpInfo">
		SELECT GrpCd, GrpNm, GrpInfo, ConfirmProcFlag,
		<isNotEmpty property="CateCd">
			#CateCd# CateCd, (SELECT CateNm FROM ib_boardCate WHERE GrpCd = #GrpCd# AND CateCd = #CateCd#) CateNm, (SELECT CateInfo FROM ib_boardCate WHERE GrpCd = #GrpCd# AND CateCd = #CateCd#) CateInfo
		</isNotEmpty>
		<isEmpty property="CateCd">'' CateCd, '' CateNm, '' CateInfo</isEmpty>
		FROM ib_boardGrp WHERE GrpCd = #GrpCd#
	</select>
																		<!-- 타이틀 -->
															
																		<!-- 게시물 -->
	<!-- 결재진행중 문서 리스트 받아오기 -->
	<select id="boardDAO.GetConfirmIngList" resultClass="egovMap">
		SELECT *
		  FROM (
		  
		  		(
		  			SELECT  '1' AS knd,
				            GrpCd,
				            CateCd,
				            '' CateNm,
				            WriteCd,
				            WriteTitle,
				            Hit,
				            DATE_FORMAT(RegDate, '%Y-%m-%d') RegDate,
				            (SELECT usr_nm FROM ib_staff WHERE sabun = a.RegPerSabun) RegPerNm,
				            '' DateNm,
				            0 FileCnt,
				            0 ReplyCnt,
				            0 ReplyFileCnt,
				            0 ReplyReadCnt,
				            0 BoardReadFlag,
				            IFNULL(EditDate, RegDate) AS oriRegDate
					  FROM ib_board a
					 WHERE GrpCd IN (SELECT GrpCd FROM ib_boardGrp WHERE ConfirmProcFlag = 'Y' AND DelFlag = 'N')
					   AND WriteStatus = 'ing' AND DelFlag = 'N'
					   AND regpersabun = #PerSabun#		  
		  		)
		  		
		  		UNION ALL
		  
				(	<!-- 최종승인자 -->
					SELECT '2' as knd, GrpCd, CateCd, (SELECT CateNm FROM ib_boardCate WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd) CateNm,
					    WriteCd, WriteTitle, Hit, DATE_FORMAT(RegDate, '%Y-%m-%d') RegDate, (SELECT usr_nm FROM ib_staff WHERE sabun = a.RegPerSabun) RegPerNm,
					   <!--  (SELECT COUNT(*) FROM ib_boardFile WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd AND WriteCd = a.WriteCd) FileCnt, -->
					    CASE DAYOFWEEK(IFNULL(EditDate, RegDate)) WHEN 1 THEN '일' WHEN 2 THEN '월' WHEN 3 THEN '화' WHEN 4 THEN '수' WHEN 5 THEN '목' WHEN 6 THEN '금' ELSE '토' END DateNm,
					    (SELECT COUNT(*) FROM ib_boardFile WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd AND WriteCd = a.WriteCd AND DelFlag = 'N') FileCnt,
						(SELECT COUNT(*) FROM ib_board_reply WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd AND WriteCd = a.WriteCd AND DelFlag = 'N') ReplyCnt,
						(SELECT COUNT(*) FROM ib_board_replyFile WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd AND WriteCd = a.WriteCd AND DelFlag = 'N') ReplyFileCnt,
						(SELECT COUNT(*) FROM ib_board_replyReadLog WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd AND WriteCd = a.WriteCd AND PerSabun = #PerSabun#) ReplyReadCnt,
						(SELECT COUNT(*) FROM ib_boardReadLog WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd AND WriteCd = a.WriteCd AND PerSabun = #PerSabun#) BoardReadFlag,
						IFNULL(EditDate, RegDate) as oriRegDate
					FROM ib_board a
					WHERE
					    GrpCd IN (SELECT GrpCd FROM ib_boardGrp WHERE ConfirmProcFlag = 'Y' AND DelFlag = 'N')
					        AND WriteStatus = 'ing' AND ConfirmPerSabun = #PerSabun# AND DelFlag = 'N'
					        AND
					        (SELECT COUNT(*) FROM ib_boardConfirmOpt
					        WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd AND WriteCd = a.WriteCd AND OptFlag = 'middle' AND DelFlag = 'N' AND PerSabun != a.ConfirmPerSabun)
							 = (SELECT COUNT(*) FROM ib_boardConfirmInfo
					        WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd AND WriteCd = a.WriteCd AND ConfirmPerSabun != a.ConfirmPerSabun AND ConfirmStatus = 'end') 
				 	
				)
				        
				UNION ALL
				
				(	<!-- 중간승인자 -->
					SELECT '2' as knd, b.GrpCd, b.CateCd, (SELECT CateNm FROM ib_boardCate WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd) CateNm,
					    b.WriteCd, WriteTitle, 0 Hit, DATE_FORMAT(b.RegDate, '%Y-%m-%d') RegDate, (SELECT usr_nm FROM ib_staff WHERE sabun = a.RegPerSabun) RegPerNm,
					    (SELECT COUNT(*) FROM ib_boardFile WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd AND WriteCd = a.WriteCd) FileCnt,
					    CASE DAYOFWEEK(IFNULL(b.EditDate, b.RegDate)) WHEN 1 THEN '일' WHEN 2 THEN '월' WHEN 3 THEN '화' WHEN 4 THEN '수' WHEN 5 THEN '목' WHEN 6 THEN '금' ELSE '토' END DateNm,
					    <!-- 0 FileCnt, --> 0 ReplyCnt, 0 ReplyFileCnt, 0 ReplyReadCnt, 0 BoardReadFlag,
					    IFNULL(b.EditDate, b.RegDate) as oriRegDate
					FROM ib_boardConfirmOpt a,
					    (SELECT GrpCd, CateCd, WriteCd, WriteTitle, RegDate, RegPerSabun, EditDate FROM ib_board
					    WHERE
					        GrpCd IN (SELECT GrpCd FROM ib_boardGrp WHERE ConfirmProcFlag = 'Y' AND DelFlag = 'N')
					            AND WriteStatus = 'ing' AND ConfirmPerSabun != #PerSabun# AND DelFlag = 'N') b
					WHERE a.GrpCd = b.GrpCd AND a.CateCd = b.CateCd AND a.WriteCd = b.WriteCd
					        AND OptFlag = 'middle' AND PerSabun = #PerSabun# AND a.DelFlag = 'N'
					        AND (SELECT COUNT(*) FROM ib_boardConfirmInfo
					        WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd AND WriteCd = a.WriteCd AND ConfirmPerSabun = a.PerSabun AND ConfirmStatus = 'end') != 1
					
				)
			) AS K
		ORDER BY knd desc, oriRegDate DESC
		/* boardDAO.GetConfirmIngList */
	</select>
	
	<!-- 반송된 문서 리스트 받아오기 -->
	<select id="boardDAO.GetReturnList" resultClass="egovMap">
		SELECT GrpCd, CateCd, (SELECT CateNm FROM ib_boardCate WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd) CateNm,
		    WriteCd, WriteTitle, DATE_FORMAT(RegDate, '%Y-%m-%d') RegDate, (SELECT PerNm FROM erp.ERP_Per WHERE PerSabun = a.RegPerSabun) PerNm,
		    (SELECT COUNT(*) FROM ib_boardFile WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd AND WriteCd = a.WriteCd) FileCnt,
		    CASE DAYOFWEEK(IFNULL(EditDate, RegDate)) WHEN 1 THEN '일' WHEN 2 THEN '월' WHEN 3 THEN '화' WHEN 4 THEN '수' WHEN 5 THEN '목' WHEN 6 THEN '금' ELSE '토' END DateNm
		FROM ib_board a
		WHERE RegPerSabun = #PerSabun# AND WriteStatus = 'return' AND DelFlag = 'N'
	</select>
	
	<!-- 휴가등록시 휴가기간 계산하기 -->
	<select id="boardDAO.HolidayPeriod" parameterClass="boardVO" resultClass="String">
		SELECT COUNT(*) FROM Calendar WHERE Cal_Date BETWEEN #HoliSDate# AND #HoliEDate#
		<isNotEqual property="HoliDocFlag" compareValue="F">AND HoliFlag = 'N'</isNotEqual>
	</select>
	
	<!-- 기간 휴가 등록시 일정시퀀스 프로시저 -->
	<procedure id="boardDAO.SetScheSeq">
		{CALL SetScheSeq()}
	</procedure>
	
	<!-- 휴가 승인 완료시 스케쥴 등록 완료 -->
	<insert id="boardDAO.HoliScheduleAddEnd">
		INSERT INTO erp.ERP_Schedule (ScheSeq, ScheGrpCd, PerSabun, ScheGubun, ScheType,
			ScheSYear, ScheSMonth, ScheSDay, ScheSDate, ScheSTimeAMPM, ScheSTime,
			ScheEYear, ScheEMonth, ScheEDay, ScheEDate, ScheETimeAMPM, ScheETime, ScheAllTime, SchePeriodFlag,
			ScheTitle, ScheArea, ScheCon, ScheRepetFlag, ScheAlarmFlag, ScheAlarmHow, ScheImportant, ScheChkFlag, ScheChkDate, SchePublicFlag, RegDate, RegPerSabun, DelFlag)
		<isEmpty property="ScheGrpCd">
		VALUES (#ScheSeq#, #ScheGrpCd#, #PerSabun#, 'Alone', 'Holiday',
			DATE_FORMAT(#ScheSDate#, '%Y'), DATE_FORMAT(#ScheSDate#, '%c'), DATE_FORMAT(#ScheSDate#, '%e'), #ScheSDate#, #ScheSTimeAMPM#, #ScheSTime#,
			DATE_FORMAT(#ScheEDate#, '%Y'), DATE_FORMAT(#ScheEDate#, '%c'), DATE_FORMAT(#ScheEDate#, '%e'), #ScheEDate#, #ScheETimeAMPM#, #ScheETime#, #ScheAllTime#, #SchePeriodFlag#,
			#ScheTitle#, #ScheArea#, #ScheCon#, 'None', 'None', 'None', #ScheImportant#, 'Y', #ScheSDate#, 'Y', NOW(), #PerSabun#, 'N')
		</isEmpty>
		<isNotEmpty property="ScheGrpCd">
			SELECT @ScheSeq:=@ScheSeq + 1, #ScheGrpCd#, #PerSabun#, 'Alone', 'Holiday',
				<!-- DATE_FORMAT(#ScheSDate#, '%Y'), DATE_FORMAT(#ScheSDate#, '%c'), --> Cal_Year, Cal_Month, Cal_Day, #ScheSDate#, #ScheSTimeAMPM#, #ScheSTime#,
				DATE_FORMAT(#ScheEDate#, '%Y'), DATE_FORMAT(#ScheEDate#, '%c'), DATE_FORMAT(#ScheEDate#, '%e'), #ScheEDate#, #ScheETimeAMPM#, #ScheETime#, #ScheAllTime#, #SchePeriodFlag#,
				#ScheTitle#, #ScheArea#, #ScheCon#, 'None', 'None', 'None', #ScheImportant#, 'Y', #ScheSDate#, 'Y', NOW(), #PerSabun#, 'N'
			FROM Calendar
			WHERE Cal_Date BETWEEN #ScheSDate# AND #ScheEDate#
			<isNotEqual property="HoliDocFlag" compareValue="F">AND HoliFlag = 'N'</isNotEqual>
		</isNotEmpty>
	</insert>
	
	<!-- 휴가 참가자 등록 완료 -->
	<insert id="boardDAO.ScheduleEntryProcEnd">
		INSERT INTO erp.ERP_ScheduleEntry (ScheSeq, PerSabun, RegPerSabun, RegDate, DelFlag)
		<isEmpty property="ScheGrpCd">VALUES (#ScheSeq#, #PerSabun#, #PerSabun#, NOW(), 'N')</isEmpty>
		<isNotEmpty property="ScheGrpCd">
			SELECT @ScheSeqEntry:=@ScheSeqEntry + 1, #PerSabun#, #PerSabun#, NOW(), 'N'
			FROM Calendar WHERE Cal_Date BETWEEN #ScheSDate# AND #ScheEDate#
			<isNotEqual property="HoliDocFlag" compareValue="F">AND HoliFlag = 'N'</isNotEqual>
		</isNotEmpty>
	</insert>
	
	<!-- 휴가 승인 완료시 연차사용내역 등록 완료 -->
	<insert id="boardDAO.WorkHoliAddEnd">
		INSERT INTO erp.ERP_HolidayStatus(PerSabun, HoliUseDate, HoliFlag, HalfFlag, PenaltyFlag, HoliReason, HoliReqDate, HoliConfirmDate, RegDate, RegPerSabun, DelFlag)
			SELECT RegPerSabun, Cal_Date, a.HoliFlag, HalfFlag, '', WriteCon, RegDate, NOW(), NOW(), RegPerSabun, 'N' FROM ib_board a, Calendar b
			WHERE GrpCd = #GrpCd# AND CateCd = #CateCd# AND WriteCd = #WriteCd# AND Cal_Date BETWEEN HoliSDate AND HoliEDate
	</insert>
	
	<!-- 게시물 총 건수 받아오기 -->
	<select id="boardDAO.selectBoardListTotalCount"  parameterClass="boardVO" resultClass="Integer">
		SELECT  count(*)
		  FROM ib_board a 
		  LEFT JOIN ib_boardcate b on a.grpcd = b.grpcd and a.catecd = b.catecd
		  LEFT OUTER JOIN synergymain.ib_staff as staff on a.RegPerSabun=staff.sabun
			<!--  해당 회사의 카테고리 enable Y 인 글만 가져오기
		  LEFT OUTER JOIN ib_board_confirmer as confirmer ON a.grpcd=confirmer.grpcd 
		  				 AND a.catecd =confirmer.catecd AND confirmer.division=#division# -->   
		  WHERE b.delflag = 'N' and a.GrpCd = #GrpCd# AND a.DelFlag = 'N' 
		  		AND CASE WHEN WriteStatus = 'write' THEN a.RegPerSabun = #RegPerSabun# ELSE 1 = 1 END
		  		<!-- AND confirmer.enable='Y' -->
			<isNotEmpty property="CateCd">AND a.CateCd = #CateCd#</isNotEmpty>
			<!-- 키워드검색시 연도 및 월 제외하고 검색 2015.02.09 -->
			<isEmpty prepend="" property="KeyWord">
				<!-- <isEmpty property="RegYear">
				DATE_FORMAT(IFNULL(EditDate, RegDate), '%Y') BETWEEN DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -1 YEAR), '%Y') AND DATE_FORMAT(NOW(), '%Y')
				</isEmpty> -->
				<isNotEmpty prepend="AND" property="RegYear">
				(DATE_FORMAT(IFNULL(EditDate, RegDate), '%Y') = #RegYear# OR NoticeFlag != '' AND NoticeEDate > NOW())
				</isNotEmpty>
			</isEmpty>
			<isNotEmpty prepend="AND" property="KeyWord"> (WriteTitle LIKE '%$KeyWord$%' OR WriteCon LIKE '%$KeyWord$%' OR (SELECT PerNm FROM erp.ERP_Per WHERE PerSabun = a.RegPerSabun) LIKE '%$KeyWord$%')</isNotEmpty>
			<isNotEqual property="RegMonth" compareValue="All">AND DATE_FORMAT(IFNULL(EditDate, RegDate), '%m') = #RegMonth#</isNotEqual>
			<isNotEmpty property="division">
				<isNotEqual property="sabun" compareValue="200402001"> 
						AND ( 	staff.division =#division# OR  
								exists (
										select 1
										from ib_boardconfirmopt
										where grpcd = a.grpcd
										  and persabun = #sabun#
								          and catecd = a.catecd
								          and writecd = a.writecd
										)
							)
				</isNotEqual>
			</isNotEmpty>
		/* boardDAO.selectBoardListTotalCount */
	</select>
	
	<!-- 게시물 받아오기 -->
	<select id="boardDAO.GetBoardList" parameterClass="boardVO" resultClass="egovMap">
		SELECT * FROM (
	        SELECT  a.GrpCd, a.CateCd, a.WriteCd, WriteTitle	<!--, WriteCon -->
	        	, IFNULL(a.editdate, a.regdate) AS createDate,
				CASE WHEN NoticeFlag IN ('Board', 'Home', 'Home,Board') THEN
						CASE WHEN NoticeEDate >= DATE_FORMAT(NOW(), '%Y-%m-%d') THEN 0 ELSE 1 END
					ELSE 1 END NoticeOrder, NoticeFlag, NoticeSDate, NoticeEDate, a.confirmpersabun,
				(SELECT COUNT(*) FROM ib_boardFile WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd AND WriteCd = a.WriteCd AND delflag = 'N') FileCnt,
				Hit, WriteStatus, BoardVer, a.RegPerSabun, (SELECT PerNm FROM erp.ERP_Per WHERE PerSabun = a.RegPerSabun) RegPerNm,
				CASE WHEN a.confirmpersabun IS NOT NULL THEN
					CASE WriteStatus WHEN 'write' THEN '임시저장' WHEN 'ing' THEN
							CASE BoardVer WHEN 1 THEN '진행중' ELSE '재기안' END
						WHEN 'return' THEN '반송' ELSE '완료' END
				END WriteStatusNm,
				CASE DAYOFWEEK(IFNULL(a.editdate, a.regdate)) WHEN 1 THEN '일' WHEN 2 THEN '월' WHEN 3 THEN '화' WHEN 4 THEN '수' WHEN 5 THEN '목' WHEN 6 THEN '금' ELSE '토' END DateNm,
				(SELECT CateNm FROM ib_boardCate WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd) CateNm,
				IF(a.regdate BETWEEN DATE_ADD(NOW(), INTERVAL  -7 DAY)  AND NOW(),1,0) newCnt,
				
				(SELECT COUNT(*) FROM ib_board_reply WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd AND WriteCd = a.WriteCd AND DelFlag = 'N') ReplyCnt,
				(SELECT COUNT(*) FROM ib_board_replyFile WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd AND WriteCd = a.WriteCd AND DelFlag = 'N') ReplyFileCnt,
				(SELECT COUNT(*) FROM ib_board_replyReadLog WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd AND WriteCd = a.WriteCd AND PerSabun = #RegPerSabun# AND ReadDate > IFNULL(a.editdate, a.regdate)) ReplyReadCnt,
				(SELECT COUNT(*) FROM ib_boardReadLog WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd AND WriteCd = a.WriteCd AND PerSabun = #RegPerSabun# AND ReadDate > IFNULL(a.editdate, a.regdate)) BoardReadFlag,
				DATE_FORMAT(IFNULL(a.editdate, a.regdate), '%Y-%m-%d') regdate, a.editdate, a.deldate, a.DelFlag,
				IFNULL(a.editdate, a.regdate) AS orgRegDate
			FROM ib_board a
			LEFT JOIN ib_boardcate b on a.grpcd = b.grpcd and a.catecd = b.catecd
				WHERE b.delflag = 'N' and a.GrpCd = #GrpCd# AND a.DelFlag = 'N' AND CASE WHEN WriteStatus = 'write' THEN a.RegPerSabun = #RegPerSabun# ELSE 1 = 1 END
					<isNotEmpty property="CateCd">AND a.CateCd = #CateCd#</isNotEmpty>
					<!-- 키워드검색시 연도 및 월 제외하고 검색 2015.02.09 -->
					<isEmpty prepend="" property="KeyWord">
						<!-- <isEmpty property="RegYear">						
						DATE_FORMAT(IFNULL(a.editdate, a.regdate), '%Y') BETWEEN DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -1 YEAR), '%Y') AND DATE_FORMAT(NOW(), '%Y')
						</isEmpty> -->
						<isNotEmpty prepend="AND" property="RegYear">
						(DATE_FORMAT(IFNULL(a.editdate, a.regdate), '%Y') = #RegYear# OR NoticeFlag != '' AND NoticeEDate > NOW())
						</isNotEmpty>
					</isEmpty>
					<isNotEmpty prepend="AND" property="KeyWord"> (WriteTitle LIKE '%$KeyWord$%' OR WriteCon LIKE '%$KeyWord$%' OR (SELECT PerNm FROM erp.ERP_Per WHERE PerSabun = a.RegPerSabun) LIKE '%$KeyWord$%')</isNotEmpty>
					<isNotEqual property="RegMonth" compareValue="All">AND DATE_FORMAT(IFNULL(a.editdate, a.regdate), '%m') = #RegMonth#</isNotEqual>
		) list
		
		<isNotEmpty prepend="" property="readN">
			 WHERE list.BoardReadFlag = 0
			 AND list.createDate > IFNULL((SELECT  PERJOINCOM  FROM erp.ERP_PER WHERE PERSABUN = #RegPerSabun#), DATE_FORMAT(NOW(), '%Y-%m-%d'))
		</isNotEmpty>
		
		<isEmpty property="OrderKey"> ORDER BY NoticeOrder, orgRegDate DESC</isEmpty>
		<isNotEmpty property="OrderKey">
			<isEqual property="OrderFlag" compareValue="S">ORDER BY NoticeOrder, $OrderKey$ $OrderType$</isEqual>
			<isNotEqual property="OrderFlag" compareValue="S">ORDER BY NoticeOrder, $OrderKey$+0 $OrderType$</isNotEqual>
		</isNotEmpty>
		<isNotEqual property="CMD" compareValue="CNT">limit #firstRecordIndex#, #recordCountPerPage#</isNotEqual>
		/*boardDAO.GetBoardList*/
	
	</select>
	
	<!-- 게시물 등록을 위한 게시물 코드 받아오기 -->
	<select id="boardDAO.GetWriteCd" parameterClass="boardVO" resultClass="String">
		<!-- SELECT IFNULL(LPAD(MAX(WriteCd) + 1, 12, 0), '000000000001') WriteCd FROM ib_board WHERE GrpCd = #GrpCd# AND CateCd = #CateCd# -->
		SELECT IFNULL(MAX(WriteCd) + 1, '1') WriteCd FROM ib_board WHERE GrpCd = #GrpCd# AND CateCd = #CateCd#
	</select>
	
	<!-- 게시물 등록/수정/삭제 완료 -->
	<insert id="boardDAO.BoardProcEnd">
		INSERT INTO ib_board (GrpCd, CateCd, WriteCd, WriteTitle, WriteCon,
			NoticeFlag, NoticeSDate, NoticeEDate, Hit, ConfirmPerSabun, WriteStatus, BoardVer, RegPerSabun, RegDate, EditDate, DelDate, DelFlag,
			EventSelCd1, EventSelCd2, EventDay, EventDoc,
			HoliDocFlag, HoliFlag, HalfFlag, HoliSDate, HoliEDate, HoliUseDay, HoliCancelCd) VALUES
		(#GrpCd#, #CateCd#, #WriteCd#, #WriteTitle#, #WriteCon#,
			#NoticeFlag#, #NoticeSDate#, #NoticeEDate#, 0, #ConfirmPerSabun#, #WriteStatus#, #BoardVer#, #RegPerSabun#, NOW(), NULL, NULL, 'N',
			#EventSelCd1#, #EventSelCd2#, #EventDay#, #EventDoc#,
			#HoliDocFlag#, #HoliFlag#, #HalfFlag#, #HoliSDate#, #HoliEDate#, #HoliUseDay#, #HoliCancelCd#)
		<isNotEqual property="CMD" compareValue="Add">ON DUPLICATE KEY UPDATE</isNotEqual>
		<isEqual property="CMD" compareValue="Edit">
			WriteTitle = VALUES(WriteTitle), WriteCon = VALUES(WriteCon), NoticeFlag = VALUES(NoticeFlag), NoticeSDate = VALUES(NoticeSDate), NoticeEDate = VALUES(NoticeEDate),
			ConfirmPerSabun = VALUES(ConfirmPerSabun), WriteStatus = VALUES(WriteStatus), BoardVer = VALUES(BoardVer), EditDate = NOW(),
			EventSelCd1 = VALUES(EventSelCd1), EventSelCd2 = VALUES(EventSelCd2), EventDay = VALUES(EventDay), EventDoc = VALUES(EventDoc),
			HoliDocFlag = VALUES(HoliDocFlag), HoliFlag = VALUES(HoliFlag), HalfFlag = VALUES(HalfFlag), HoliSDate = VALUES(HoliSDate), HoliEDate = VALUES(HoliEDate), HoliUseDay = VALUES(HoliUseDay), HoliCancelCd = VALUES(HoliCancelCd)
		</isEqual>
		<isEqual property="CMD" compareValue="Del">DelDate = NOW(), DelFlag = 'Y'</isEqual>
	</insert>
	
	<!-- 게시물 요청관련 담당자&참조인 등록/수정 완료 -->
	<insert id="boardDAO.BoardConfirmOptProcEnd" parameterClass="java.util.List">
		INSERT INTO ib_boardConfirmOpt (GrpCd, CateCd, WriteCd, PerSabun, OptFlag, RegPerSabun, RegDate, EditPerSabun, EditDate, DelFlag) VALUES
        <dynamic>
		<iterate conjunction=",">
			(#[].GrpCd#, #[].CateCd#, #[].WriteCd#, #[].PerSabun#, #[].OptFlag#, #[].RegPerSabun#, NOW(), NULL, NULL, #[].DelFlag#)
		</iterate>
		</dynamic>
		ON DUPLICATE KEY UPDATE EditPerSabun = VALUES(RegPerSabun), EditDate = NOW(), DelFlag = VALUES(DelFlag)
	</insert>
	
	<!-- 게시물 요청관련 담당자&참조인 삭제 완료 -->
	<delete id="boardDAO.BoardConfirmOptDelEnd" parameterClass="boardVO">
		DELETE FROM ib_boardConfirmOpt WHERE GrpCd = #GrpCd# AND CateCd = #CateCd# AND WriteCd = #WriteCd#
	</delete>
	
	<!-- 게시물 파일코드 받아오기 -->
	<select id="boardDAO.GetBoardFileSeq"  parameterClass="boardVO" resultClass="int">
		SELECT IFNULL(MAX(FileSeq) + 1, '1') FileSeq FROM ib_boardFile WHERE GrpCd = #GrpCd# AND CateCd = #CateCd# AND WriteCd = #WriteCd#
	</select>
	
	<!-- 게시물 파일 등록 완료 -->
	<insert id="boardDAO.BoardFileAddEnd" parameterClass="java.util.List">
		INSERT INTO ib_boardFile (GrpCd, CateCd, WriteCd, FileSeq, FileNm, FileUpNm, FilePath, FileSize, FileOrder, RegDate, DelDate, DelFlag) VALUES
		<dynamic>
		<iterate conjunction=","  >
		(#[].GrpCd#, #[].CateCd#, #[].WriteCd#, #[].FileSeq#, #[].FileNm#, #[].FileUpNm#, #[].FilePath#, #[].FileSize#, #[].FileOrder#, NOW(), NULL, 'N')
		</iterate>
		</dynamic>
	</insert>
	
	<!-- 게시물 보고완료처리 완료 -->
	<update id="boardDAO.BoardWriteEnd">
		UPDATE ib_board SET WriteStatus = 'ing' WHERE GrpCd = #GrpCd# AND CateCd = #CateCd# AND WriteCd = #WriteCd#
	</update>
	
	<!-- 보고서 승인/반송 처리 완료 -->
	<update id="boardDAO.BoardConfirmEnd">
		UPDATE ib_board SET WriteStatus = #WriteStatus# WHERE GrpCd = #GrpCd# AND CateCd = #CateCd# AND WriteCd = #WriteCd#
	</update>
	
	<!-- 보고서 승인/반송 처리 정보 등록 완료 -->
	<insert id="boardDAO.BoardConfirmInfoAddEnd">
		INSERT INTO ib_boardConfirmInfo (GrpCd, CateCd, WriteCd, ConfirmStatus, ConfirmCon, ConfirmPerSabun, ConfirmDate) VALUES
		(#GrpCd#, #CateCd#, #WriteCd#, #WriteStatus#, #ConfirmCon#, #RegPerSabun#, NOW())
	</insert>
	
	<!-- 게시물 정보 받아오기 -->
	<select id="boardDAO.GetBoardInfo" resultMap="BoardInfo">
		SELECT a.GrpCd, GrpNm, ConfirmProcFlag, 
		    CateCd, (SELECT CateNm FROM ib_boardCate WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd) CateNm,
		    WriteCd, WriteTitle, 
		    
		    CASE WHEN #RegPerSabun# = '200402001' THEN REPLACE(WriteCon, 'font-size: 10pt;', 'font-size: 11pt;') 
		    ELSE WriteCon END WriteCon,
		    
		    NoticeFlag, NoticeSDate, NoticeEDate,
		    ConfirmPerSabun, (SELECT PerNm FROM erp.ERP_Per WHERE PerSabun = ConfirmPerSabun) ConfirmPerNm, Hit, WriteStatus, BoardVer,
		    HoliDocFlag, HoliFlag, HalfFlag, HoliSDate, HoliEDate, HoliUseDay, HoliCancelCd,
		    CASE HoliFlag WHEN 'half' THEN '반차' ELSE '종일' END HoliFlagNm,
		    CASE HalfFlag WHEN 'am' THEN '오전' WHEN 'pm' THEN '오후' ELSE '' END HalfFlagNm,
		    CASE DAYOFWEEK(HoliSDate) WHEN 1 THEN '일' WHEN 2 THEN '월' WHEN 3 THEN '화' WHEN 4 THEN '수' WHEN 5 THEN '목' WHEN 6 THEN '금' ELSE '토' END HoliSDateNm,
			CASE DAYOFWEEK(HoliEDate) WHEN 1 THEN '일' WHEN 2 THEN '월' WHEN 3 THEN '화' WHEN 4 THEN '수' WHEN 5 THEN '목' WHEN 6 THEN '금' ELSE '토' END HoliEDateNm,
			EventSelCd1, EventSelCd2, EventDay, EventDoc,
			
			REPLACE(REPLACE(DATE_FORMAT(IFNULL(a.EditDate, a.RegDate), '%Y-%m-%d %p %h:%i'), 'AM', '오전'), 'PM', '오후') RegDate,
		    a.RegPerSabun, b.PerNm RegPerNm,
		    (SELECT COUNT(*) FROM ib_boardConfirmOpt WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd AND WriteCd = a.WriteCd AND OptFlag = 'middle' AND DelFlag = 'N') MiddleCnt,
			(SELECT COUNT(*) FROM ib_boardConfirmInfo WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd AND WriteCd = a.WriteCd AND ConfirmStatus = 'end') EndCnt,
			(SELECT COUNT(*) FROM ib_boardConfirmInfo WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd AND WriteCd = a.WriteCd AND ConfirmStatus = 'return') ReturnCnt
			,(SELECT positionNm FROM erp.erp_per_position where positionCd = b.PerPosition) PerPositionNm
			, PerDept, PerJoinCom, b.DelFlag
		FROM ib_board a, erp.ERP_Per b, ib_boardGrp c
		WHERE a.GrpCd = #GrpCd# AND a.CateCd = #CateCd# AND a.WriteCd = #WriteCd# AND a.DelFlag = 'N'
			AND a.RegPerSabun = b.PerSabun AND a.GrpCd = c.GrpCd
	</select>
	
	<!-- 게시물 요청관련 중간승인자&참조인 리스트 받아오기 -->
	<select id="boardDAO.GetBoardConfirmOptPerList" resultClass="egovMap">
		SELECT opt.GrpCd, opt.CateCd, opt.WriteCd, PerSabun, (SELECT PerNm FROM erp.ERP_Per WHERE PerSabun = opt.PerSabun) PerNm, OptFlag, DelFlag,
			ConfirmStatus, ConfirmCon, DATE_FORMAT(ConfirmDate, '%Y-%m-%d %H:%i') ConfirmDate, CASE ConfirmStatus WHEN 'return' THEN '반송' WHEN 'end' THEN '완료' END ConfirmStatusNm,
			(SELECT COUNT(1) FROM ib_boardConfirmInfo WHERE GrpCd = opt.GrpCd AND CateCd = opt.CateCd AND WriteCd = opt.WriteCd AND ConfirmPerSabun = PerSabun AND ConfirmStatus = 'end') EndFlag,
			(SELECT COUNT(1) FROM ib_boardConfirmInfo WHERE GrpCd = opt.GrpCd AND CateCd = opt.CateCd AND WriteCd = opt.WriteCd) ConfirmCnt
		FROM ib_boardConfirmOpt opt
		LEFT OUTER JOIN ib_boardConfirmInfo info
		ON opt.GrpCd = info.GrpCd AND opt.CateCd = info.CateCd AND opt.WriteCd = info.WriteCd AND PerSabun = ConfirmPerSabun AND OptFlag = 'middle'
		WHERE opt.GrpCd = #GrpCd# AND opt.CateCd = #CateCd# AND opt.WriteCd = #WriteCd# AND DelFlag = 'N'
		ORDER BY OptFlag, CASE OptFlag WHEN 'Consult' THEN PerNm END, ConfirmDate DESC
	</select>
	
	<!-- 게시물 파일리스트 받아오기 -->
	<select id="boardDAO.GetBoardFileList" parameterClass="boardVO" resultClass="egovMap">
		SELECT GrpCd, CateCd, WriteCd, FileSeq, FileNm, FileUpNm, REPLACE(FilePath, '\\', '\\\\') FilePath,
		CASE WHEN FileSize / 1024 > 1024 THEN  CONCAT(ROUND(FileSize / 1024 / 1024, 1), 'MB') ELSE CONCAT(ROUND(FileSize / 1024, 1), 'KB') END FileSize, FileOrder, RegDate,
		CASE 
		WHEN FileNm LIKE '%doc%' THEN '/images/sp/ext_ico/ico_doc.gif'
		WHEN FileNm LIKE '%xls%' THEN '/images/sp/ext_ico/ico_excel.gif'
		WHEN FileNm LIKE '%hwp%' THEN '/images/sp/ext_ico/ico_hwp.gif'
		WHEN FileNm LIKE '%jpg%' OR FileNm LIKE '%jpeg%' THEN '/images/sp/ext_ico/ico_jpg.gif'
		WHEN FileNm LIKE '%pdf%' THEN '/images/sp/ext_ico/ico_pdf.gif'
		WHEN FileNm LIKE '%txt%' THEN '/images/sp/ext_ico/ico_txt.gif'
		ELSE '/images/sp/file.gif' END FileIco
		 FROM ib_boardFile WHERE GrpCd = #GrpCd# AND CateCd = #CateCd# AND WriteCd = #WriteCd# AND DelFlag = 'N' ORDER BY RegDate, FileOrder
	</select>
	
	<!-- 게시물 파일 정보 받아오기 -->
	<select id="boardDAO.GetBoardFileInfo" resultMap="BoardFileInfo">
		SELECT GrpCd, CateCd, WriteCd, FileSeq, FileNm, FileUpNm, REPLACE(FilePath, '\\', '\\\\') FilePath, FileSize, FileOrder FROM ib_boardFile
			  WHERE GrpCd = #GrpCd# AND CateCd = #CateCd# AND WriteCd = #WriteCd# AND FileSeq = #FileSeq# AND DelFlag = 'N' ORDER BY RegDate, FileOrder
	</select>
	
	<!-- 게시물 파일 삭제 완료 -->
	<update id="boardDAO.BoardFileDelEnd">
		UPDATE ib_boardFile SET DelDate = NOW(), DelFlag = 'Y' WHERE GrpCd = #GrpCd# AND CateCd = #CateCd# AND WriteCd = #WriteCd#
		<isNotEmpty property="FileSeq">AND FileSeq = #FileSeq#</isNotEmpty>
	</update>
	
	<!-- 게시물 조회 정보 등록 완료 -->
	<insert id="boardDAO.BoardReadAddEnd">
		INSERT INTO ib_boardReadLog (GrpCd, CateCd, WriteCd, PerSabun, ReadDate) VALUES
		(#GrpCd#, #CateCd#, #WriteCd#, #RegPerSabun#, NOW())
		ON DUPLICATE KEY UPDATE ReadDate = NOW()
	</insert>
	
	<!-- 게시물 조회수 업데이트 완료 -->
	<update id="boardDAO.BoardHitEditEnd">
		UPDATE ib_board SET Hit = Hit + 1 WHERE GrpCd = #GrpCd# AND CateCd = #CateCd# AND WriteCd = #WriteCd#
	</update>
	
	<!-- 게시물 조회 로그 리스트 불러오기 -->
	<select id="boardDAO.GetBoardReadLogList" resultClass="egovMap">
		SELECT PerSabun, (SELECT PerNm FROM erp.ERP_Per WHERE PerSabun = a.PerSabun) PerNm, DATE_FORMAT(ReadDate, '%Y-%m-%d %H:%i') ReadDate
		FROM ib_boardReadLog a
		WHERE GrpCd = #GrpCd# AND CateCd = #CateCd# AND WriteCd = #WriteCd#
		ORDER BY ReadDate DESC
	</select>
	
	<!-- 게시물 이동 완료 -->
	<update id="boardDAO.BoardMoveEnd" parameterClass="boardVO">
		UPDATE ib_board
			SET CateCd = #CateCd#, WriteCd = #WriteCd#
		WHERE GrpCd = #GrpCd# AND CateCd = #OldCateCd# AND WriteCd = #OldWriteCd#;
	</update>
	
	<!-- 게시물 이동에 따른 파일 이동 완료 -->
	<update id="boardDAO.BoardFileMoveEnd" parameterClass="boardVO">
		UPDATE ib_boardFile
			SET CateCd = #CateCd#, WriteCd = #WriteCd#
		WHERE GrpCd = #GrpCd# AND CateCd = #OldCateCd# AND WriteCd = #OldWriteCd#;
	</update>
	
	<!-- 게시물 이동에 따른 댓글 이동 완료 -->
	<update id="boardDAO.ReplyMoveEnd" parameterClass="boardVO">
		UPDATE ib_board_reply
			SET CateCd = #CateCd#, WriteCd = #WriteCd#
		WHERE GrpCd = #GrpCd# AND CateCd = #OldCateCd# AND WriteCd = #OldWriteCd#;
	</update>
	
	<!-- 게시물 이동에 따른 댓글 파일 이동 완료 -->
	<update id="boardDAO.ReplyFileMoveEnd" parameterClass="boardVO">
		UPDATE ib_board_replyFile
			SET CateCd = #CateCd#, WriteCd = #WriteCd#
		WHERE GrpCd = #GrpCd# AND CateCd = #OldCateCd# AND WriteCd = #OldWriteCd#;
	</update>
	
	<!-- 게시물 이동에 따른 조회로그 이동 완료 -->
	<update id="boardDAO.ReadLogMoveEnd" parameterClass="boardVO">
		UPDATE ib_boardReadLog
			SET CateCd = #CateCd#, WriteCd = #WriteCd#
		WHERE GrpCd = #GrpCd# AND CateCd = #OldCateCd# AND WriteCd = #OldWriteCd#;
	</update>
	
	<!-- 게시물 이동에 따른 댓글 조회로그 이동 완료 -->
	<update id="boardDAO.ReplyReadLogMoveEnd" parameterClass="boardVO">
		UPDATE ib_board_replyReadLog
			SET CateCd = #CateCd#, WriteCd = #WriteCd#
		WHERE GrpCd = #GrpCd# AND CateCd = #OldCateCd# AND WriteCd = #OldWriteCd#;
	</update>
	
	<!-- 게시물 이동에 따른 참조인 이동 완료 -->
	<update id="boardDAO.ConfirmMoveEnd" parameterClass="boardVO">
		UPDATE ib_boardConfirmOpt
			SET CateCd = #CateCd#, WriteCd = #WriteCd#
		WHERE GrpCd = #GrpCd# AND CateCd = #OldCateCd# AND WriteCd = #OldWriteCd#;
	</update>
	
	<!-- 게시물 이동에 따른 승인정보 이동 완료 -->
	<update id="boardDAO.ConfirmInfoMoveEnd" parameterClass="boardVO">
		UPDATE ib_boardConfirmInfo
			SET CateCd = #CateCd#, WriteCd = #WriteCd#
		WHERE GrpCd = #GrpCd# AND CateCd = #OldCateCd# AND WriteCd = #OldWriteCd#;
	</update>
	
	<!-- 휴가 취소 보고를 위한 신청한 휴가내역 불러오기 -->
	<select id="boardDAO.GetHoliList" parameterClass="boardVO" resultClass="egovMap">
		SELECT WriteCd, SUBSTRING(SUBSTRING(WriteCon, 1, POSITION(']' IN WriteCon)), 6) HoliPeriod FROM ib_board
		WHERE GrpCd = '1' AND CateCd = '2' AND RegPerSabun = #RegPerSabun# AND WriteStatus = 'end' AND DelFlag = 'N' AND HoliSDate >= DATE_FORMAT(NOW(), '%Y-%m-%d')
		<isEqual property="CMD" compareValue="Add">
			AND WriteCd NOT IN (SELECT IFNULL(HoliCancelCd, '') FROM ib_board WHERE GrpCd = '1' AND CateCd = '3' AND RegPerSabun = #RegPerSabun# AND DelFlag = 'N')
		</isEqual>
	</select>
	
	<!-- 휴가 취소에 따른 일정 내역 삭제 완료 -->
	<update id="boardDAO.ScheEditEnd" parameterClass="boardVO">
		UPDATE erp.ERP_Schedule 
		SET DelFlag = 'Y'
		WHERE ScheSeq IN (SELECT ScheSeq FROM
			(SELECT ScheSeq FROM erp.ERP_Schedule a, ib_board b
			WHERE a.ScheType = 'Holiday' AND a.persabun = #PerSabun#
				AND b.GrpCd = '1' AND b.CateCd = '2' AND b.WriteCd = #HoliCancelCd#
				AND b.RegPerSabun = #PerSabun# AND b.WriteStatus = 'end' AND b.DelFlag = 'N'
				AND a.ScheSDate = b.HoliSDate AND a.ScheEDate = b.HoliEDate) c)
	</update>
	
	<!-- 휴가 취소에 따른 연차 내역 삭제 완료 -->
	<update id="boardDAO.HoliEditEnd" parameterClass="boardVO">
		UPDATE erp.ERP_HolidayStatus 
		SET DelFlag = 'Y'
		WHERE PerSabun = #PerSabun# AND DelFlag = 'N'
			AND HoliUseDate in (SELECT DATE_FORMAT(CONCAT(ScheSYear, '-', ScheSMonth, '-', ScheSDay), '%Y-%m-%d')
			FROM erp.ERP_Schedule a, ib_board b
			WHERE a.ScheType = 'Holiday' AND a.persabun = #PerSabun#
				AND b.GrpCd = '1' AND b.CateCd = '2' AND b.WriteCd = #HoliCancelCd#
				AND b.RegPerSabun = #PerSabun# AND b.WriteStatus = 'end' AND b.DelFlag = 'N'
				AND a.ScheSDate = b.HoliSDate AND a.ScheEDate = b.HoliEDate)
	</update>
																		<!-- 게시물 -->
																		
																		<!-- 댓글 -->
	<!-- 댓글 리스트 -->
	<select id="boardDAO.GetReplyList" parameterClass="boardVO" resultClass="egovMap">
		SELECT GrpCd, CateCd, WriteCd, ReplyCd, ReplyCon, ReplyPerSabun, (SELECT PerNm FROM erp.ERP_Per WHERE PerSabun = ReplyPerSabun) ReplyPerNm,
			REPLACE(REPLACE(DATE_FORMAT(RegDate, '%Y-%m-%d<![CDATA[<br>]]>%p %h:%i'), 'AM','오전'), 'PM', '오후') RegDate, DelFlag, RegDate RegDate2,
			(SELECT COUNT(*) CNT FROM ib_board_replyFile WHERE GrpCd = a.GrpCd AND CateCd = a.CateCd AND WriteCd = a.WriteCd AND ReplyCd = a.ReplyCd AND DelFlag = 'N') CNT
		FROM ib_board_reply a WHERE GrpCd = #GrpCd# AND CateCd = #CateCd# AND WriteCd = #WriteCd# AND DelFlag = 'N'
		ORDER BY RegDate2
	</select>
	
	<!-- 댓글 파일 리스트 -->
	<select id="boardDAO.GetReplyFileList" parameterClass="boardVO" resultClass="egovMap">
		SELECT GrpCd, CateCd, WriteCd, ReplyCd, FileSeq, FileNm, FileUpNm, REPLACE(FilePath, '\\', '\\\\') FilePath, FileSize, FileOrder
		FROM ib_board_replyFile WHERE GrpCd = #GrpCd# AND CateCd = #CateCd# AND WriteCd = #WriteCd# AND DelFlag = 'N'
		ORDER BY RegDate, FileOrder
	</select>
	
	<!-- 댓글 코드 받아오기 -->
	<select id="boardDAO.GetReplyCd"  parameterClass="boardVO" resultClass="String">
		<!-- SELECT IFNULL(LPAD(MAX(ReplyCd) + 1, 12, 0), '000000000001') ReplyCd FROM ib_board_reply WHERE GrpCd = #GrpCd# AND CateCd = #CateCd# AND WriteCd = #WriteCd# -->
		SELECT IFNULL(MAX(ReplyCd) + 1, '1') ReplyCd FROM ib_board_reply WHERE GrpCd = #GrpCd# AND CateCd = #CateCd# AND WriteCd = #WriteCd#
	</select>
	
	<!-- 댓글 등록/수정/삭제 완료 -->
	<insert id="boardDAO.ReplyProcEnd">
		INSERT INTO ib_board_reply (GrpCd, CateCd, WriteCd, ReplyCd, ReplyCon, ReplyPerSabun,
			RegDate, EditDate, DelDate, DelFlag) VALUES
		(#GrpCd#, #CateCd#, #WriteCd#, #ReplyCd#, #ReplyCon#, #ReplyPerSabun#,
			NOW(), NULL, NULL, 'N')
		<isNotEqual property="CMD" compareValue="Add">ON DUPLICATE KEY UPDATE</isNotEqual>
		<isEqual property="CMD" compareValue="Edit">ReplyCon = VALUES(ReplyCon), EditDate = NOW()</isEqual>
		<isEqual property="CMD" compareValue="Del">DelDate = NOW(), DelFlag = 'Y'</isEqual>
	</insert>
	
	<!-- 댓글 파일코드 받아오기 -->
	<select id="boardDAO.GetReplyFileSeq"  parameterClass="boardVO" resultClass="int">
		SELECT IFNULL(MAX(FileSeq) + 1, '1') FileSeq FROM ib_board_replyFile WHERE GrpCd = #GrpCd# AND CateCd = #CateCd# AND WriteCd = #WriteCd# AND ReplyCd = #ReplyCd#
	</select>
	
	<!-- 댓글 파일 등록 완료 -->
	<insert id="boardDAO.ReplyFileAddEnd" parameterClass="java.util.List">
		INSERT INTO ib_board_replyFile (GrpCd, CateCd, WriteCd, ReplyCd, FileSeq, FileNm, FileUpNm, FilePath, FileSize, FileOrder, RegDate, DelDate, DelFlag) VALUES
		<dynamic>
		<iterate conjunction=","  >
		<!-- (#[].GrpCd#, #[].CateCd#, #[].WriteCd#, #[].ReplyCd#, LPAD(#[].FileSeq#, 12, 0), #[].FileNm#, #[].FileUpNm#, #[].FilePath#, #[].FileSize#, #[].FileOrder#, NOW(), NULL, 'N') -->
		(#[].GrpCd#, #[].CateCd#, #[].WriteCd#, #[].ReplyCd#, #[].FileSeq#, #[].FileNm#, #[].FileUpNm#, #[].FilePath#, #[].FileSize#, #[].FileOrder#, NOW(), NULL, 'N')
		</iterate>
		</dynamic>
	</insert>
	
	<!-- 댓글 파일 삭제 완료 -->
	<update id="boardDAO.ReplyFileDelEnd">
		UPDATE ib_board_replyFile SET DelDate = NOW(), DelFlag = 'Y' WHERE GrpCd = #GrpCd# AND CateCd = #CateCd# AND WriteCd = #WriteCd# AND ReplyCd = #ReplyCd#
	</update>
	
	<!-- 댓글 조회 정보 등록 완료 -->
	<insert id="boardDAO.ReplyReadAddEnd" parameterClass="java.util.List">
		INSERT INTO ib_board_replyReadLog (GrpCd, CateCd, WriteCd, ReplyCd, PerSabun, ReadDate) VALUES
		<dynamic>
		<iterate conjunction=","  >
		(#[].GrpCd#, #[].CateCd#, #[].WriteCd#, #[].ReplyCd#, #[].PerSabun#, NOW())
		</iterate>
		</dynamic>
		ON DUPLICATE KEY UPDATE ReadDate = NOW()
	</insert>
																		<!-- 댓글 -->
</sqlMap>